# Appwrite Database Integration

This document explains how OnlyFunds integrates with Appwrite database for cloud storage of transactions and budgets, while maintaining localStorage for fast local access.

## üèóÔ∏è Architecture Overview

The application uses a **hybrid storage strategy**:

1. **Local Storage (Primary)**: Fast access, immediate UI updates
2. **Appwrite Cloud (Secondary)**: Data persistence, synchronization across devices

### Data Flow

```
User Action ‚Üí Update Local Storage ‚Üí Update UI ‚Üí Sync to Appwrite (Background)
```

On Login ‚Üí Fetch from Local Storage ‚Üí Display Data ‚Üí Sync from Appwrite ‚Üí Update Local Storage

## üìä Database Schema

### Collections Required in Appwrite

**Important Note on ID Handling:**
We use a dual-ID approach for consistency between localStorage and Appwrite:

- **Appwrite Document ID**: Auto-generated by Appwrite (used internally)
- **Custom ID Field**: Our application-generated ID (stored as `id` attribute, used for queries)

This ensures data consistency when syncing between localStorage and cloud storage.

#### 1. `transactions` Collection

**Attributes:**

- `id` (String, Required) - Our custom transaction ID for consistency with localStorage
- `userId` (String, Required) - Links transaction to user
- `type` (String, Required) - 'expense' or 'income'
- `amount` (Double, Required) - Transaction amount
- `description` (String, Required) - Transaction description
- `category` (String, Required) - Expense or income category
- `date` (DateTime, Required) - Transaction date
- `createdAt` (DateTime, Required) - Record creation timestamp
- `updatedAt` (DateTime, Required) - Last update timestamp

#### 2. `budgets` Collection

**Attributes:**

- `id` (String, Required) - Our custom budget ID for consistency with localStorage
- `userId` (String, Required) - Links budget to user
- `category` (String, Required) - Expense category
- `amount` (Double, Required) - Budget amount
- `month` (Integer, Required) - Budget month (1-12)
- `year` (Integer, Required) - Budget year
- `createdAt` (DateTime, Required) - Record creation timestamp
- `updatedAt` (DateTime, Required) - Last update timestamp

## üîß Setup Instructions

### 1. Create Appwrite Project

1. Go to [Appwrite Cloud](https://cloud.appwrite.io/) or your self-hosted instance
2. Create a new project
3. Note your Project ID

### 2. Create Database and Collections

1. In your Appwrite console, go to **Databases**
2. Create a new database (e.g., "main")
3. Create two collections: "transactions" and "budgets"
4. Add the attributes as specified in the schema above

### 3. Set Up Permissions

For each collection, configure these permissions:

**Create Permissions:**

- `users` (allows any authenticated user to create)

**Read Permissions:**

- `user:[USER_ID]` (users can only read their own data)

**Update Permissions:**

- `user:[USER_ID]` (users can only update their own data)

**Delete Permissions:**

- `user:[USER_ID]` (users can only delete their own data)

### 4. Environment Configuration

Copy `env.example` to `.env.local` and fill in your values:

```env
# Appwrite Configuration
NEXT_PUBLIC_APPWRITE_ENDPOINT=https://cloud.appwrite.io/v1
NEXT_PUBLIC_APPWRITE_PROJECT_ID=your_project_id_here
NEXT_PUBLIC_APPWRITE_DATABASE_ID=main
NEXT_PUBLIC_APPWRITE_TRANSACTIONS_COLLECTION_ID=transactions
NEXT_PUBLIC_APPWRITE_BUDGETS_COLLECTION_ID=budgets
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### 5. Collection Indexes (Optional but Recommended)

For better performance, create these indexes:

**transactions collection:**

- Index on `userId` (ascending)
- Index on `userId, createdAt` (ascending, descending)
- Index on `userId, type` (ascending, ascending)

**budgets collection:**

- Index on `userId` (ascending)
- Index on `userId, createdAt` (ascending, descending)
- Index on `userId, category, month, year` (ascending, ascending, ascending, ascending)

## üîÑ How Synchronization Works

### Data Priority

1. **Local Storage First**: All operations update localStorage immediately
2. **Background Sync**: Appwrite operations happen in the background
3. **Merge Strategy**: On login, cloud data is merged with local data

### Sync Triggers

- **Login/Signup**: Syncs cloud data to local storage
- **Add Transaction/Budget**: Saves locally ‚Üí syncs to cloud
- **Update/Delete**: Updates locally ‚Üí syncs to cloud

### Conflict Resolution

The current implementation uses a simple strategy:

- **Cloud data takes precedence** during sync
- **Local-only data** is preserved and synced to cloud
- **No complex conflict resolution** (assumes single-user access per account)

## üö® Error Handling

### Graceful Degradation

If Appwrite is unavailable:

- ‚úÖ App continues to work with localStorage
- ‚ö†Ô∏è Warning messages in console (not shown to user)
- üîÑ Operations retry when connectivity returns

### Configuration Validation

The app checks for proper Appwrite configuration:

- Missing environment variables ‚Üí warnings logged
- Invalid project ‚Üí fallback to local-only mode
- Network errors ‚Üí silent background failures

## üîê Security Considerations

### Data Access

- **User Isolation**: Users can only access their own data
- **Authentication Required**: All database operations require valid session
- **Server-Side Validation**: Appwrite validates all requests server-side

### Environment Variables

- All Appwrite config uses `NEXT_PUBLIC_` prefix (client-side access required)
- No sensitive server keys in client code
- Production values should be set in hosting platform environment

## üß™ Testing

### Local Development

1. Set up Appwrite project and collections
2. Configure `.env.local` with your project details
3. Test with authentication enabled
4. Monitor browser console for sync status

### Offline Testing

1. Disable network in browser dev tools
2. Verify app works with localStorage only
3. Re-enable network and check background sync

## üìà Performance Optimizations

### Implemented

- **Immediate UI Updates**: localStorage changes reflect instantly
- **Background Sync**: Cloud operations don't block user interface
- **Selective Sync**: Only syncs on login, not on every operation
- **Error Isolation**: Cloud failures don't affect local functionality

### Future Improvements

- **Delta Sync**: Only sync changed records
- **Conflict Detection**: Compare timestamps for conflict resolution
- **Retry Logic**: Automatic retry for failed sync operations
- **Data Compression**: Optimize payload size for large datasets

## üêõ Troubleshooting

### Common Issues

**"Appwrite not configured"**

- Check environment variables in `.env.local`
- Verify project ID is correct
- Ensure endpoint is accessible

**Permissions errors**

- Verify collection permissions allow user access
- Check if user is properly authenticated
- Confirm userId matches Appwrite session

**Sync not working**

- Check browser console for error messages
- Verify internet connectivity
- Test Appwrite console access manually

### Debug Mode

Enable verbose logging by adding to console:

```javascript
localStorage.setItem("debug", "appwrite:*");
```

## üîÑ Migration Guide

### From Local-Only to Appwrite

1. Set up Appwrite project and collections
2. Configure environment variables
3. Deploy updated application
4. User data automatically syncs on next login
5. No data loss - local storage preserved

### Schema Changes

When adding new fields:

1. Update Appwrite collection attributes
2. Update TypeScript interfaces
3. Update database service functions
4. Test with existing data

---

**Note**: This integration maintains backward compatibility. If Appwrite is not configured, the app continues to work in local-only mode.
